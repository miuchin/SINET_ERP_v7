<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SINET Ponude v14.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="sinet_core_v7.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        body { background: #f5f3ff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; overflow: hidden; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .paper { background: white; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); min-height: 200mm; padding: 10mm; font-size: 11px; }
        @media print {
            body { background: white; overflow: visible; height: auto; }
            #sidebar, #header, .no-print { display: none !important; }
            #main-area { width: 100%; overflow: visible; }
            .paper { box-shadow: none; margin: 0; padding: 0; width: 100%; }
        }
    </style>
</head>
<body class="flex flex-col h-screen text-slate-800">

    <div id="header" class="bg-indigo-900 text-white p-4 shadow-lg flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-3">
            <button onclick="window.location.href='index.html'" class="p-2 rounded-full hover:bg-indigo-700">
                <span class="material-icons-round">arrow_back</span>
            </button>
            <div>
                <h1 class="text-lg font-bold flex items-center gap-2">
                    <span class="material-icons-round text-indigo-300">topic</span> 
                    PONUDE & PREGOVORI
                </h1>
                <p class="text-[10px] text-indigo-300 uppercase tracking-widest">Sales Pipeline</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="Quote.print()" class="bg-white text-indigo-900 px-4 py-2 rounded-lg text-xs font-bold uppercase shadow flex items-center gap-2">
                <span class="material-icons-round text-sm">print</span> ≈†tampaj
            </button>
            <button onclick="Quote.newQuote()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase shadow flex items-center gap-2">
                <span class="material-icons-round text-sm">add</span> Nova Ponuda
            </button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        
        <div id="sidebar" class="w-1/3 bg-white border-r border-slate-200 flex flex-col min-w-[300px]">
            <div class="p-4 border-b border-slate-100 bg-slate-50">
                <input id="search-q" onkeyup="Quote.filter()" class="w-full bg-white border border-slate-200 rounded-lg p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500" placeholder="üîç Tra≈æi klijenta ili broj...">
                <div class="flex gap-2 mt-2 overflow-x-auto pb-1">
                    <button onclick="Quote.filterStatus('ALL')" class="px-2 py-1 rounded bg-slate-200 text-[10px] font-bold">SVE</button>
                    <button onclick="Quote.filterStatus('DRAFT')" class="px-2 py-1 rounded bg-yellow-100 text-yellow-700 text-[10px] font-bold">U PRIPREMI</button>
                    <button onclick="Quote.filterStatus('SENT')" class="px-2 py-1 rounded bg-blue-100 text-blue-700 text-[10px] font-bold">POSLATO</button>
                    <button onclick="Quote.filterStatus('ACCEPTED')" class="px-2 py-1 rounded bg-green-100 text-green-700 text-[10px] font-bold">‚úÖ REALIZOVANO</button>
                </div>
            </div>
            <div id="quote-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
        </div>

        <div id="main-area" class="w-2/3 bg-slate-100 flex flex-col relative overflow-y-auto hide-scroll p-4 md:p-8 items-center">
            
            <div id="action-bar" class="w-full max-w-[210mm] mb-4 flex justify-between items-center hidden no-print">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-slate-500 uppercase">STATUS:</span>
                    <select id="q-status" onchange="Quote.save(false)" class="bg-white border border-slate-300 rounded px-2 py-1 text-xs font-bold">
                        <option value="DRAFT">üìù U PRIPREMI</option>
                        <option value="SENT">‚úâÔ∏è POSLATO KLIJENTU</option>
                        <option value="DECLINED">‚ùå ODBIJENO</option>
                        <option value="ACCEPTED">‚úÖ PRIHVAƒÜENO</option>
                    </select>
                </div>
                <button onclick="Quote.convertToInvoice()" id="btn-convert" class="bg-green-600 text-white px-6 py-2 rounded-full text-xs font-bold uppercase shadow-lg hover:bg-green-700 flex items-center gap-2 transition transform active:scale-95">
                    <span class="material-icons-round">check_circle</span> PRETVORI U FAKTURU
                </button>
            </div>

            <div id="paper" class="paper w-full max-w-[210mm] hidden">
                <div class="flex justify-between items-start border-b-2 border-slate-800 pb-4 mb-6">
                    <div class="w-1/2">
                        <h2 id="lbl-firm" class="text-lg font-black uppercase text-slate-800">MOJA FIRMA</h2>
                        <div class="text-xs text-slate-600 space-y-0.5 mt-2">
                            <p id="lbl-addr">Adresa...</p>
                            <p>PIB: <span id="lbl-pib">-</span> | MB: <span id="lbl-mb">-</span></p>
                            <p>TR: <span id="lbl-acc">-</span></p>
                        </div>
                    </div>
                    <div class="w-1/2 text-right">
                        <h1 class="text-2xl font-black uppercase text-indigo-900">PONUDA</h1>
                        <div class="flex flex-col items-end mt-2 space-y-1">
                            <div class="flex justify-end gap-2 items-center"><span class="text-[10px] font-bold text-slate-400">BROJ:</span><input id="q-num" class="text-right font-mono font-bold text-lg bg-transparent outline-none w-32" placeholder="2025-001"></div>
                            <div class="flex justify-end gap-2 items-center"><span class="text-[10px] font-bold text-slate-400">DATUM:</span><input type="date" id="q-date" class="text-right font-mono text-sm bg-transparent outline-none"></div>
                            <div class="flex justify-end gap-2 items-center"><span class="text-[10px] font-bold text-slate-400">VA≈ΩI DO:</span><input type="date" id="q-valid" class="text-right font-mono text-sm bg-transparent outline-none"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-6">
                    <label class="text-[9px] font-black text-indigo-400 uppercase mb-1 block no-print">KLIJENT</label>
                    <input id="q-client-search" list="client-list" onchange="Quote.selectClient(this.value)" class="w-full bg-transparent font-bold text-lg outline-none placeholder-indigo-300 mb-1" placeholder="Unesite naziv klijenta...">
                    <datalist id="client-list"></datalist>
                    <div class="flex gap-4 text-xs text-slate-600">
                        <input id="q-client-addr" class="bg-transparent w-full outline-none" placeholder="Adresa">
                        <input id="q-client-pib" class="bg-transparent w-32 outline-none font-mono" placeholder="PIB">
                    </div>
                </div>

                <datalist id="art-list"></datalist>
                <table class="w-full mb-6">
                    <thead class="bg-slate-100 text-[10px] font-black text-slate-600 uppercase border-b-2 border-slate-800">
                        <tr><th class="p-2 text-left w-8">Br</th><th class="p-2 text-left">Opis</th><th class="p-2 text-right w-16">Kol</th><th class="p-2 text-right w-24">Cena</th><th class="p-2 text-right w-24">Ukupno</th><th class="p-2 w-6 no-print"></th></tr>
                    </thead>
                    <tbody id="items-body"></tbody>
                </table>

                <div class="no-print mb-8 text-center">
                    <button onclick="Quote.addItem()" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full text-xs font-bold uppercase hover:bg-indigo-200">+ Dodaj Stavku</button>
                </div>

                <div class="flex justify-end">
                    <div class="w-1/3 bg-slate-50 p-3 rounded-xl border border-slate-200">
                        <div class="flex justify-between py-1 text-xs"><span>Osnovica:</span><span id="sum-net" class="font-mono">0.00</span></div>
                        <div class="flex justify-between py-1 text-xs text-slate-500"><span>PDV (20%):</span><span id="sum-pdv" class="font-mono">0.00</span></div>
                        <div class="border-t border-slate-300 my-2 pt-2 flex justify-between text-lg font-black text-slate-800"><span>UKUPNO:</span><span id="sum-total">0.00 RSD</span></div>
                    </div>
                </div>

                <div class="mt-8 pt-4 border-t border-slate-300 text-xs text-slate-500">
                    <p class="italic">Napomena: Ova ponuda nije fiskalni raƒçun. Robu i cene rezervi≈°emo do roka va≈æenja ponude.</p>
                    <textarea id="q-note" class="w-full mt-2 bg-transparent italic outline-none resize-none" placeholder="Dodatne napomene..."></textarea>
                </div>
            </div>

            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                <span class="material-icons-round text-6xl mb-4 text-slate-300">folder_open</span>
                <p>Izaberite ponudu ili kreirajte novu.</p>
            </div>

        </div>
    </div>

    <button onclick="Quote.save(true)" class="fixed bottom-6 right-6 bg-indigo-600 text-white p-4 rounded-full shadow-2xl flex items-center justify-center active:scale-90 transition z-50 no-print hover:bg-indigo-700"><span class="material-icons-round text-3xl">save</span></button>

    <script>
        const Quote = {
            data: { items: [] }, list: [], clients: [], articles: [], config: {}, currentId: null,

            init: () => {
                Quote.config = SINET.Config.load();
                Quote.list = SINET.DB.get('quotes') || [];
                Quote.clients = SINET.DB.get('clients') || [];
                Quote.articles = SINET.DB.get('articles') || [];
                
                // Populate Lists
                document.getElementById('client-list').innerHTML = Quote.clients.map(c => `<option value="${c.osnovno.naziv}">`).join('');
                document.getElementById('art-list').innerHTML = Quote.articles.map(a => `<option value="${a.name}">${SINET.Util.fmtMoney(a.price)}</option>`).join('');
                
                // Header Info
                document.getElementById('lbl-firm').innerText = Quote.config.firma.naziv;
                document.getElementById('lbl-addr').innerText = Quote.config.adresa.ulica;
                document.getElementById('lbl-pib').innerText = Quote.config.firma.pib;
                document.getElementById('lbl-mb').innerText = Quote.config.firma.mb;
                document.getElementById('lbl-acc').innerText = Quote.config.banka.racun1;

                Quote.renderList(Quote.list);
            },

            filter: () => {
                const term = document.getElementById('search-q').value.toLowerCase();
                Quote.renderList(Quote.list.filter(q => q.client.toLowerCase().includes(term) || q.num.includes(term)));
            },

            filterStatus: (st) => {
                if(st === 'ALL') Quote.renderList(Quote.list);
                else Quote.renderList(Quote.list.filter(q => q.status === st));
            },

            renderList: (lst) => {
                const c = document.getElementById('quote-list');
                if(lst.length === 0) { c.innerHTML = '<div class="p-4 text-center text-xs text-slate-400">Nema ponuda.</div>'; return; }
                
                // Sort by date desc
                lst.sort((a,b) => b.date.localeCompare(a.date));

                c.innerHTML = lst.map(q => {
                    let badge = "";
                    if(q.status === 'DRAFT') badge = '<span class="bg-yellow-100 text-yellow-700 px-1 rounded">PRIPREMA</span>';
                    if(q.status === 'SENT') badge = '<span class="bg-blue-100 text-blue-700 px-1 rounded">POSLATO</span>';
                    if(q.status === 'ACCEPTED') badge = '<span class="bg-green-100 text-green-700 px-1 rounded">REALIZOVANO</span>';
                    if(q.status === 'DECLINED') badge = '<span class="bg-red-100 text-red-700 px-1 rounded">ODBIJENO</span>';
                    
                    const active = Quote.currentId === q.id ? 'border-l-4 border-indigo-500 bg-indigo-50' : 'hover:bg-slate-50';

                    return `
                    <div onclick="Quote.select('${q.id}')" class="p-3 border-b border-slate-100 cursor-pointer transition ${active}">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-mono font-bold text-xs text-slate-500">${q.num}</span>
                            <span class="text-[9px] font-bold uppercase">${badge}</span>
                        </div>
                        <h4 class="font-bold text-sm text-slate-800 truncate">${q.client}</h4>
                        <p class="text-[10px] text-slate-400 mt-1 flex justify-between">
                            <span>${SINET.Util.fmtDate(q.date)}</span>
                            <span class="font-bold text-indigo-600">${q.total}</span>
                        </p>
                    </div>`;
                }).join('');
            },

            newQuote: () => {
                Quote.currentId = null;
                Quote.data = { items: [] };
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('paper').classList.remove('hidden');
                document.getElementById('action-bar').classList.remove('hidden');
                
                // Reset inputs
                const nextNum = (Quote.list.filter(q => q.date.startsWith(new Date().getFullYear())).length + 1);
                document.getElementById('q-num').value = `PON-${new Date().getFullYear()}-${String(nextNum).padStart(3,'0')}`;
                document.getElementById('q-date').valueAsDate = new Date();
                document.getElementById('q-valid').valueAsDate = new Date(Date.now() + 7*86400000); // +7 dana
                document.getElementById('q-client-search').value = "";
                document.getElementById('q-client-addr').value = "";
                document.getElementById('q-client-pib').value = "";
                document.getElementById('q-status').value = "DRAFT";
                document.getElementById('q-note').value = "";
                
                // Sakrij Convert dugme za novu ponudu
                document.getElementById('btn-convert').classList.add('hidden');
                Quote.renderItems();
            },

            select: (id) => {
                const q = Quote.list.find(x => x.id === id);
                if(!q) return;
                Quote.currentId = id;
                Quote.data = JSON.parse(JSON.stringify(q)); // Deep copy
                
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('paper').classList.remove('hidden');
                document.getElementById('action-bar').classList.remove('hidden');

                // Fill Data
                document.getElementById('q-num').value = q.num;
                document.getElementById('q-date').value = q.date;
                document.getElementById('q-valid').value = q.validUntil;
                document.getElementById('q-client-search').value = q.client;
                document.getElementById('q-client-addr').value = q.clientAddr || "";
                document.getElementById('q-client-pib').value = q.clientPib || "";
                document.getElementById('q-status').value = q.status;
                document.getElementById('q-note').value = q.note || "";

                // Logic for Convert Button
                if(q.status === 'ACCEPTED') {
                    document.getElementById('btn-convert').classList.add('hidden'); // Veƒá je fakturisano
                } else {
                    document.getElementById('btn-convert').classList.remove('hidden');
                }

                Quote.renderList(Quote.list); // Re-render for highlight
                Quote.renderItems();
            },

            selectClient: (val) => {
                const c = Quote.clients.find(x => x.osnovno.naziv === val);
                if(c) {
                    document.getElementById('q-client-search').value = c.osnovno.naziv;
                    document.getElementById('q-client-addr').value = c.kontakt.adresa;
                    document.getElementById('q-client-pib').value = c.osnovno.pib;
                }
            },

            addItem: () => {
                Quote.data.items.push({ desc: "", qty: 1, price: 0 });
                Quote.renderItems();
            },

            removeItem: (idx) => {
                Quote.data.items.splice(idx, 1);
                Quote.renderItems();
            },

            handleItemInput: (idx, field, val) => {
                Quote.data.items[idx][field] = val;
                if(field === 'desc') {
                    const art = Quote.articles.find(a => a.name === val);
                    if(art) {
                        Quote.data.items[idx].price = art.price;
                        Quote.renderItems();
                    }
                }
                if(field === 'qty' || field === 'price') {
                    Quote.calcTotal();
                    document.getElementById(`row-total-${idx}`).innerText = SINET.Util.fmtMoney(Quote.data.items[idx].qty * Quote.data.items[idx].price);
                }
            },

            renderItems: () => {
                document.getElementById('items-body').innerHTML = Quote.data.items.map((it, i) => `
                    <tr class="border-b border-slate-100">
                        <td class="p-2 text-center text-slate-400 text-xs">${i+1}</td>
                        <td class="p-1"><input list="art-list" onchange="Quote.handleItemInput(${i}, 'desc', this.value)" value="${it.desc}" class="w-full bg-transparent font-bold text-xs outline-none" placeholder="Opis..."></td>
                        <td class="p-1"><input type="number" onchange="Quote.handleItemInput(${i}, 'qty', this.value)" value="${it.qty}" class="w-full text-right bg-slate-50 rounded px-1 text-xs"></td>
                        <td class="p-1"><input type="number" onchange="Quote.handleItemInput(${i}, 'price', this.value)" value="${it.price}" class="w-full text-right bg-slate-50 rounded px-1 text-xs"></td>
                        <td class="p-2 text-right font-mono text-xs font-bold" id="row-total-${i}">${SINET.Util.fmtMoney(it.qty * it.price)}</td>
                        <td class="p-1 text-center no-print"><button onclick="Quote.removeItem(${i})" class="text-red-400 hover:bg-red-50 rounded-full p-1">‚úï</button></td>
                    </tr>
                `).join('');
                Quote.calcTotal();
            },

            calcTotal: () => {
                const totalNet = Quote.data.items.reduce((sum, it) => sum + (it.qty * it.price), 0);
                const net = totalNet / 1.2;
                const pdv = totalNet - net;
                
                document.getElementById('sum-net').innerText = SINET.Util.fmtMoney(net);
                document.getElementById('sum-pdv').innerText = SINET.Util.fmtMoney(pdv);
                document.getElementById('sum-total').innerText = SINET.Util.fmtMoney(totalNet) + " RSD";
            },

            save: (notify = true) => {
                const q = {
                    id: Quote.currentId || SINET.Util.uuid(),
                    num: document.getElementById('q-num').value,
                    date: document.getElementById('q-date').value,
                    validUntil: document.getElementById('q-valid').value,
                    client: document.getElementById('q-client-search').value,
                    clientAddr: document.getElementById('q-client-addr').value,
                    clientPib: document.getElementById('q-client-pib').value,
                    status: document.getElementById('q-status').value,
                    note: document.getElementById('q-note').value,
                    items: Quote.data.items,
                    total: document.getElementById('sum-total').innerText
                };

                if(!q.client) return alert("Unesite klijenta!");

                const idx = Quote.list.findIndex(x => x.id === q.id);
                if(idx > -1) Quote.list[idx] = q; else Quote.list.unshift(q);
                
                SINET.DB.save('quotes', Quote.list);
                Quote.currentId = q.id;
                Quote.renderList(Quote.list);
                
                if(notify) alert("Ponuda saƒçuvana!");
            },

            convertToInvoice: () => {
                if(!confirm("Da li ≈æelite da pretvorite ovu Ponudu u Fakturu?\n\n- Ponuda ƒáe dobiti status 'REALIZOVANO'\n- Kreiraƒáe se nova Faktura u sistemu\n- Roba ƒáe se rezervisati/skinuti sa stanja")) return;

                Quote.save(false); // Save first

                // 1. Get Next Invoice Number
                const docs = SINET.DB.get('docs') || [];
                const year = new Date().getFullYear();
                const cnt = docs.filter(d => d.type === 'FAKTURA' && d.date.startsWith(year)).length + 1;
                const newInvNum = `${year}-${String(cnt).padStart(3,'0')}`;

                // 2. Create Invoice Object
                const newInvoice = {
                    id: SINET.Util.uuid(),
                    type: 'FAKTURA',
                    num: newInvNum,
                    date: new Date().toISOString().split('T')[0],
                    client: { 
                        name: document.getElementById('q-client-search').value, 
                        pib: document.getElementById('q-client-pib').value 
                    },
                    total: document.getElementById('sum-total').innerText,
                    // Use stored value or recalc
                    total_net: SINET.Util.fmtMoney(SINET.Util.parseMoney(document.getElementById('sum-total').innerText) / 1.2),
                    items: Quote.data.items.map(i => ({...i, type: 'prod'})), // Ensure type is set
                    meta: { 
                        due: document.getElementById('q-valid').value, 
                        note: `Generisano iz Ponude ${document.getElementById('q-num').value}`,
                        currency: "RSD"
                    },
                    sef_status: 'NEW'
                };

                // 3. Save Invoice
                docs.unshift(newInvoice);
                SINET.DB.save('docs', docs);

                // 4. Update Quote Status
                document.getElementById('q-status').value = "ACCEPTED";
                Quote.save(false);

                alert(`‚úÖ USPEH!\nKreirana je Faktura broj: ${newInvNum}\n\nSada ƒáete biti preusmereni na fakturu.`);
                
                // 5. Redirect to Invoice View (using query param hack or simple redirect)
                // Najjednostavnije: Idi na listu faktura pa neka korisnik vidi
                // Ili pametnije: Save ID to localstorage and open Invoice
                // Ali po≈°to Invoice modul nema deep-link u initu, samo ƒáemo otiƒái na fakture.
                window.location.href = "04_invoice_v7.html";
            },

            print: () => window.print()
        };
        Quote.init();
    </script>
</body>
</html>
