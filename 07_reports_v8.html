<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SINET KIF & Export v8.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="sinet_core_v7.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        body { background: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding-bottom: 80px; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            body { background: white; padding: 0; font-size: 10px; }
            #header, #controls, .no-print, .chk-col { display: none !important; }
            #report-view { display: block !important; box-shadow: none !important; border: none !important; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #000; padding: 4px; }
            th { background-color: #eee !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div id="header" class="bg-orange-700 text-white p-4 sticky top-0 z-50 shadow-lg flex justify-between items-center">
        <div class="flex items-center gap-3">
            <button onclick="window.location.href='index.html'" class="p-2 rounded-full hover:bg-orange-600"><span class="material-icons-round">arrow_back</span></button>
            <h1 class="text-lg font-bold">KIF & SEF</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="Report.exportSelectedXML()" class="bg-orange-900 px-3 py-2 rounded-lg text-xs font-bold uppercase shadow flex items-center gap-2 border border-orange-500 hover:bg-orange-800">
                <span class="material-icons-round text-sm">code</span> SEF XML
            </button>
            <button onclick="Report.exportCSV()" class="bg-orange-600 px-3 py-2 rounded-lg text-xs font-bold uppercase shadow flex items-center gap-2">
                <span class="material-icons-round text-sm">file_download</span> CSV
            </button>
            <button onclick="window.print()" class="bg-white text-orange-800 px-3 py-2 rounded-lg text-xs font-bold uppercase shadow flex items-center gap-2">
                <span class="material-icons-round text-sm">print</span>
            </button>
        </div>
    </div>

    <div id="controls" class="p-4 bg-white border-b border-slate-200 sticky top-[68px] z-40">
        <div class="grid grid-cols-2 gap-4 max-w-2xl mx-auto">
            <div><label class="text-[9px] font-bold text-slate-400">OD</label><input type="date" id="r-start" onchange="Report.genKIF()" class="w-full p-2 border rounded font-bold"></div>
            <div><label class="text-[9px] font-bold text-slate-400">DO</label><input type="date" id="r-end" onchange="Report.genKIF()" class="w-full p-2 border rounded font-bold"></div>
        </div>
        <div class="flex justify-center gap-2 mt-3 overflow-x-auto hide-scroll pb-1">
            <button onclick="Report.setPeriod('month')" class="px-3 py-1 bg-orange-50 text-orange-700 rounded text-xs font-bold">MESEC</button>
            <button onclick="Report.setPeriod('q1')" class="px-3 py-1 bg-slate-100 text-slate-600 rounded text-xs font-bold">KVARTAL</button>
            <button onclick="Report.setPeriod('year')" class="px-3 py-1 bg-slate-100 text-slate-600 rounded text-xs font-bold">GODINA</button>
        </div>
    </div>

    <div class="p-4 md:p-8">
        <div id="report-view" class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 max-w-5xl mx-auto min-h-[297mm]">
            <div class="text-center mb-6 border-b-2 border-black pb-4">
                <h2 class="text-2xl font-black uppercase text-slate-800">Knjiga Izlaznih Faktura (KIF)</h2>
                <p class="text-sm font-bold mt-1" id="rep-period">Period: -</p>
                <p class="text-xs text-slate-500 mt-1" id="rep-firm">Moja Firma</p>
            </div>

            <table class="w-full text-xs text-slate-700">
                <thead class="bg-slate-100 font-bold uppercase text-slate-600 border-y-2 border-slate-300">
                    <tr>
                        <th class="p-2 w-8 chk-col"><input type="checkbox" onclick="Report.toggleAll(this)"></th>
                        <th class="p-2 text-left w-8">R.Br</th>
                        <th class="p-2 text-left w-24">Dokument</th>
                        <th class="p-2 text-center w-24">Datum</th>
                        <th class="p-2 text-left">Kupac</th>
                        <th class="p-2 text-right w-24">Ukupno</th>
                    </tr>
                </thead>
                <tbody id="rep-body"></tbody>
                <tfoot class="font-bold border-t-2 border-black bg-slate-50 text-sm">
                    <tr>
                        <td colspan="5" class="p-3 text-right">UKUPNO:</td>
                        <td class="p-3 text-right" id="sum-total">0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        const Report = {
            data: [], filtered: [],
            
            init: () => {
                Report.data = SINET.DB.get('docs') || [];
                Report.setPeriod('month');
            },

            setPeriod: (p) => {
                const now = new Date(); const y = now.getFullYear();
                const s = document.getElementById('r-start'); const e = document.getElementById('r-end');
                if(p==='month') { s.value = new Date(y, now.getMonth(), 1).toISOString().split('T')[0]; e.value = new Date(y, now.getMonth()+1, 0).toISOString().split('T')[0]; }
                else if(p==='q1') { s.value = `${y}-01-01`; e.value = `${y}-03-31`; }
                else if(p==='year') { s.value = `${y}-01-01`; e.value = `${y}-12-31`; }
                Report.genKIF();
            },

            genKIF: () => {
                const start = document.getElementById('r-start').value;
                const end = document.getElementById('r-end').value;
                const config = SINET.Config.load();
                document.getElementById('rep-firm').innerText = config.firma.naziv;
                document.getElementById('rep-period').innerText = `Od ${SINET.Util.fmtDate(start)} do ${SINET.Util.fmtDate(end)}`;

                Report.filtered = Report.data.filter(d => d.date >= start && d.date <= end && (d.type === 'FAKTURA' || d.type === 'AVANSNI RAČUN' || d.type === 'KNJIŽNO ODOBRENJE'));
                Report.filtered.sort((a,b) => a.date.localeCompare(b.date));

                let sumTot = 0;
                const rows = Report.filtered.map((d, i) => {
                    let total = SINET.Util.parseMoney(d.total);
                    if(d.type === 'KNJIŽNO ODOBRENJE' && total > 0) total = -total;
                    sumTot += total;

                    const statusClass = d.sef_status === 'SENT' ? 'bg-green-50 border-l-4 border-green-500' : 'border-b border-slate-200';
                    const statusBadge = d.sef_status === 'SENT' ? '<span class="text-[9px] bg-green-200 text-green-800 px-1 rounded ml-1">SEF</span>' : '';

                    return `
                    <tr class="${statusClass} hover:bg-slate-100 transition">
                        <td class="p-2 text-center chk-col"><input type="checkbox" class="xml-chk" value="${d.id}"></td>
                        <td class="p-2 text-center">${i+1}</td>
                        <td class="p-2 font-bold">${d.num} ${statusBadge} <span class="text-[9px] text-red-500">${d.type==='KNJIŽNO ODOBRENJE'?'(K.O.)':''}</span></td>
                        <td class="p-2 text-center">${SINET.Util.fmtDate(d.date)}</td>
                        <td class="p-2 truncate max-w-[150px]">${d.client.name}</td>
                        <td class="p-2 text-right font-bold font-mono">${SINET.Util.fmtMoney(total)}</td>
                    </tr>`;
                }).join('');

                document.getElementById('rep-body').innerHTML = rows;
                document.getElementById('sum-total').innerText = SINET.Util.fmtMoney(sumTot);
            },

            toggleAll: (el) => { document.querySelectorAll('.xml-chk').forEach(c => c.checked = el.checked); },

            exportSelectedXML: async () => {
                const checked = Array.from(document.querySelectorAll('.xml-chk:checked')).map(c => c.value);
                if(checked.length === 0) return alert("Čekirajte bar jednu fakturu!");

                const config = SINET.Config.load();
                let count = 0;

                for (const id of checked) {
                    const doc = Report.data.find(d => d.id === id);
                    if(doc) {
                        const xmlDoc = JSON.parse(JSON.stringify(doc));
                        xmlDoc.client.pib = (xmlDoc.client.pib || "").replace("PIB: ", "").trim();
                        const xmlContent = SINET.SEF.generateXML(xmlDoc, config);
                        const filename = `SEF_${xmlDoc.num}_${xmlDoc.client.name.replace(/ /g,'_')}.xml`;
                        
                        if(xmlContent) {
                            SINET.SEF.download(filename, xmlContent);
                            SINET.DB.markAsExported(id);
                            count++;
                            await new Promise(r => setTimeout(r, 500));
                        }
                    }
                }
                alert(`Preuzeto ${count} XML fajlova!`);
                Report.genKIF();
            },

            // --- POPRAVLJENI CSV EXPORT SA BOM-om (\uFEFF) ---
            exportCSV: () => {
                const rows = [];
                rows.push(["R.Br", "Dokument", "Datum", "Kupac", "Ukupno"]);
                
                const trs = document.querySelectorAll('#rep-body tr');
                trs.forEach(tr => {
                    const tds = tr.querySelectorAll('td');
                    if(tds.length > 1) {
                        rows.push([
                            tds[1].innerText, 
                            tds[2].innerText, 
                            tds[3].innerText, 
                            tds[4].innerText, 
                            tds[5].innerText
                        ]);
                    }
                });

                let csvContent = rows.map(e => e.join(",")).join("\n");
                
                // BOM za Excel UTF-8 podršku
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "SINET_KIF_IZVESTAJ.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };
        Report.init();
    </script>
</body>
</html>
